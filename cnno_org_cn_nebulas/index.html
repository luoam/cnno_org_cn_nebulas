
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="keywords" content="核点点">
    <meta name="description" content="核点点">
    <meta name="author" content="核点点">
    <title>城市与核电厂辐射监测数据交易平台</title>
    <!-- Loading Bootstrap -->
    <link href="http://static.anman.org/static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="http://static.anman.org/static/bootstrap/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="http://static.anman.org/static/jquery/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="http://static.anman.org/static/bootstrap/js/bootstrap.min.js"></script>
    <script src="http://static.anman.org/static/bootstrap/js/bootbox.min.js"></script>
    <script src="http://static.anman.org/static/bootstrap/js/nebulas.js"></script>
    <script src="http://static.anman.org/static/bootstrap/js/nebPay.js"></script>
    <script src="http://static.anman.org/static/bootstrap/js/moment-with-locales.min.js"></script>
    <script src="http://static.anman.org/static/bootstrap/js/bootstrap-datetimepicker.min.js"></script>
    <style type="text/css">


        .noExtension {
            margin: auto;
            font-size: 23px;
        }

        .order {
            margin-top: 1rem;
            display: none;
        }


    </style>
</head>
<body>
<style type="text/css">
    .navbar-toggle .icon-bar{
        background-color: #000;
    }
</style>
<!-- Static navbar -->
<nav class="navbar navbar-static-top" style="margin-bottom:1px;">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://www.cnno.org.cn/"><b>城市与核电厂辐射监测数据交易平台</b></a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="http://www.cnno.org.cn/index/index"><b>辐射数据</b></a></li>
            </ul>
            <div class="nav navbar-right">
                <form class="navbar-form navbar-left" action="http://www.cnno.org.cn/index/search/" onsubmit="return asearch()">
                    <div class="form-group">
                        <div class="input-group">
                            <input class="form-control" id="search" name="search" type="search" placeholder="">
                            <span class="input-group-btn">
            <button type="submit" class="btn btn-default">搜索</button>
          </span>
                        </div>
                    </div>
                </form>
            </div>
        </div><!--/.nav-collapse -->
    </div>
</nav>
<script>
    function asearch()
    {
        var search = $("#search").val();
        if(search.length>0){
            location.href = "http://www.cnno.org.cn/index/search/" + search;
        }
        return false;
    }
</script>
<section id="noExtension" style="margin-top:1px;padding-bottom: 0px;background-color:red; color:#fff;display: none;">
    <div class="container">
        <div class="row">
            <div class="noExtension col-md-12" id="noExtension">
                注意: 请安装谷歌浏览器扩展<a target="_blank" href="https://github.com/ChengOrangeJu/WebExtensionWallet">WebExtensionWallet</a>
            </div>
        </div>
    </div>
</section>
<section id="data7"
         style="margin-top:1px;padding-bottom: 0px;background-color:rgba(76, 174, 76, 0.84); color:#fff;min-height: 400px;">
    <div class="container">
        <div class="row">

            <div class="col-sm-12" style="text-align: center">

                <div class="col-lg-6" style="padding-top:50px;padding-bottom:50px;">
                    <h4 id="title"></h4>
                    <p class="space10" id="description">

                    </p>
                    <p class="space10">
                    <h2 id="price"></h2>
                    </p>
                    <p class="space10">
                        <input type="button" id="buy" onclick="buy()" class="btn btn-danger" value="填写订单"
                               name="buy" id="buy">
                    </p>
                    <p class="space10">
                        <div class="col-md-12 order" id="order">
                            <label for="order_description">购买时请注意填写联系方式等信息，便于客服与您取得联系</label>
                            <textarea class="form-control" id="order_description" cols="5"></textarea>
                    <p class="small">少于200字</p>
                    <input type="button" id="neworder" onclick="neworder()" class="btn btn-danger" value="提交订单"
                           name="neworder" id="neworder">
                </div>
                </p>
                <p class="space10">数据展示：<a style="color:#ffffff;" href="http://www.cnno.org.cn">全国城市及核电厂辐射数据监测平台</a></p>
            </div>
            <div class="col-lg-6">

                <img style="margin-top:10px;margin-bottom:10px;margin-left:10px;margin-right:10px;"
                     src="http://anmanopen.qiniudn.com/static/img/fushe1.png"/>
            </div>
        </div>
    </div>
    </div>
</section>
<script>
    function asearch() {
        var search = $("#search").val();
        if (search.length > 0) {
            location.href = "http://www.cnno.org.cn/index/";
        }
        return false;
    }
</script>


<div class="fade loading modal" data-backdrop=static>
    <div class=modal-dialog>
        <div class=modal-content>
            <div class=modal-body>
                <div class=progress>
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role=progressbar
                         style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>


<!--黄-->
<section id="data7"
         style="margin-top:1px;padding-bottom: 0px;background-color:rgba(239, 172, 77, 0.85); color:#fff;min-height: 400px;">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="col-lg-6">

                    <img style="margin-top:10px;margin-bottom:10px;margin-left:10px;margin-right:10px;"
                         src="http://anmanopen.qiniudn.com/static/img/fushe1.png"/>
                </div>
                <div class="col-lg-6" style="padding-top:50px;padding-bottom:50px;">
                    <h4 style="text-align: center">城市与核电厂辐射监测数据</h4>
                    <p class="space10">
                        数据主要来源于国家辐射环境监测网辐射环境自动监测站自动监测结果，监测点位包括环境质量监测点和核电厂监测点。
                    </p>
                    <p class="space10">
                        环境质量监测点主要分布于全国各大中城市，自动站一般安置在城市中的公园、绿地、建筑物顶等相对固定点。
                    </p>
                    <p class="space10">
                        核电厂监测点主要分布于核电厂厂界周围，自动站一般以反应堆为中心按不同距离和方位分成若干扇形进行布设
                    </p>
                </div>
            </div>
        </div>
    </div>
</section>

<footer class="bg-fff ">
    <div class="container-fluid" style="border-top: 1px solid #ddd">
        <div class="row">
            <div class="col-xs-12 text-center">
                <h4 class="footer-title">Copyright © 2017-2050 <a href="http://www.cnno.org.cn/">城市与核电厂辐射监测数据交易平台</a>. <a
                        href="http://www.miibeian.gov.cn/">浙ICP备14037650号</a>
                </h4>
                <p><a href='#'>Go Top</a></p>
            </div>
        </div>
    </div>

</footer>


<script>
    "use strict";
    var nebulas = require("nebulas"),
        Utils = nebulas.Utils,
        neb = new nebulas.Neb();
    //Testnet:
    // var ContractAddress = "n1hanfmmw697ZK5RQSjxFcwCWTgJvbgy86o";
    // var chainId = "1001";
    // var initAddress = "n1LRdxLWijiqci8zTF72o84y7npUBrizp8a";
    // neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));

    //Mainnet:
    var ContractAddress = "n1uf2jCXf7qbZj72YirdY66x24mWHuVN7dW";
    var chainId = "1";
    var initAddress = "n1Lvduf7mV6NBXwi43ahP3RqRKrnp6jHa8D";
    neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
    var Amount = 0;
    var goodid;
    var timer;

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();


    if (typeof(webExtensionWallet) === "undefined") {
        $("#noExtension").show();
    }
    $(document).ready(function () {
        $("textarea").keyup(function () {

            var c = $(this).val();
            if (c.length > 200) {
                c = c.substr(0, 200);
                $(this).val(c);
            }
            var last = 200 - c.length;
            $("p.small").text("还能输入" + last + "字");
        });
        $(".modal.loading").modal("show");
        initCall(function (params) {
            neb.api
                .call({
                    from: params.from,
                    to: params.to,
                    value: params.value,
                    nonce: params.nonce,
                    gasPrice: params.gasPrice,
                    gasLimit: params.gasLimit,
                    contract: params.contract
                })
                .then(function (resp) {
                    let arr = JSON.parse(resp.result);
                    let arra = JSON.parse(arr);
                    if (arra) {
                        let gooditem = arra[0];
                        console.log(gooditem);
                        let title = gooditem.title;
                        let description = gooditem.description;
                        let price = gooditem.price;
                        Amount = price;
                        goodid = gooditem.saler + gooditem.timestamp;

                        $("#title").text(title);
                        $("#description").text(description);
                        $("#price").text("价格：" + price + "NAS");
                    }
                    $(".modal.loading").modal("hide");


                    if (resp.execute_err && resp.execute_err !== "") {
                        console.log(resp.execute_err);
                    } else {
                    }
                })
                .catch(function (err) {
                    $(".modal.loading").modal("hide");
                    bootbox.dialog({
                        backdrop: true,
                        onEscape: true,
                        message: err.message,
                        size: "large",
                        title: "Error"
                    });
                });
        });

    });

    var initCall = function (callback) {
        var params = {};

        params.from = initAddress;
        params.to = ContractAddress;
        params.gasLimit = Utils.toBigNumber("200000").toNumber();
        params.gasPrice = Utils.toBigNumber("1000000").toNumber();

        // prepare value
        let value = Utils.toBigNumber(0);
        params.value = value;

        // prepare contract

        var args = "";
        params.contract = {
            "function": "GoodList",
            "args": args
        };

        // prepare nonce
        // needs refresh data on every 'test' and 'commit' call, because data update may slow,
        // you can get different result by hit 'test' multiple times
        neb.api.getAccountState(params.from).then(function (resp) {
            var balance = nebulas.Unit.fromBasic(resp.balance, "nas");
            params.nonce = parseInt(resp.nonce) + 1;
            callback(params);
        }).catch(function (err) {
            // console.log("prepare nonce error: " + err);
            bootbox.dialog({
                backdrop: true,
                onEscape: true,
                message: err.message,
                size: "large",
                title: "Error"
            });
        });
    };

    var buy = function () {
        $("#order").show();
    };

    var neworder = function () {
        let result = [];
        let order_description = $("#order_description").val();
        result.push(goodid);
        result.push(order_description);
        let callArgs = JSON.stringify(result);
        let callFunction = "NewOrder";
        nebPay.call(ContractAddress, Amount, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: cbPush        //设置listener, 处理交易返回信息
        });
    };
    var cbPush = function (resp) {
        console.log("response of push: " + JSON.stringify(resp))
    };

</script>
</body>
</html>

